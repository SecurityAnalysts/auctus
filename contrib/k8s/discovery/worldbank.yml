---
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: worldbank
  labels:
    app: auctus
    what: worldbank
spec:
  schedule: "0 1 * * 1,3,5"
  jobTemplate:
    metadata:
      labels:
        app: auctus
        what: worldbank
    spec:
      template:
        metadata:
          labels:
            app: auctus
            what: worldbank
        spec:
          restartPolicy: Never
          securityContext:
            runAsNonRoot: true
          containers:
          - name: worldbank
            image: auctus_worldbank
            imagePullPolicy: IfNotPresent
            env:
            - name: LOG_FORMAT
              valueFrom:
                configMapKeyRef:
                  name: config
                  key: log.format
            - name: ELASTICSEARCH_HOSTS
              value: elasticsearch:9200
            - name: ELASTICSEARCH_PREFIX
              valueFrom:
                configMapKeyRef:
                  name: config
                  key: elasticsearch_prefix
            - name: AMQP_HOST
              value: rabbitmq
            - name: AMQP_PORT
              value: "5672"
            - name: AMQP_USER
              valueFrom:
                secretKeyRef:
                  name: secrets
                  key: amqp.user
            - name: AMQP_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: secrets
                  key: amqp.password
            - name: S3_KEY
              valueFrom:
                secretKeyRef:
                  name: secrets
                  key: s3.key
            - name: S3_SECRET
              valueFrom:
                secretKeyRef:
                  name: secrets
                  key: s3.secret
            - name: S3_URL
              valueFrom:
                configMapKeyRef:
                  name: config
                  key: s3.url
            - name: S3_CLIENT_URL
              valueFrom:
                configMapKeyRef:
                  name: config
                  key: s3.client_url
            - name: S3_BUCKET_PREFIX
              valueFrom:
                configMapKeyRef:
                  name: config
                  key: s3.bucket_prefix
            - name: GCS_PROJECT
              valueFrom:
                configMapKeyRef:
                  name: config
                  key: gcs.project
            - name: GCS_CREDS
              valueFrom:
                secretKeyRef:
                  name: secrets
                  key: gcs.creds
            - name: GCS_BUCKET_PREFIX
              valueFrom:
                configMapKeyRef:
                  name: config
                  key: gcs.bucket_prefix
            - name: LAZO_SERVER_HOST
              value: lazo
            - name: LAZO_SERVER_PORT
              value: "50051"
